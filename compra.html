<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="estilo.css">
    <title>Finalizar Compra</title>
</head>

<body>

<header>
    <ul class="navigation">
        <li><a href="index.html">Voltar</a></li>
    </ul>
</header>

<div id="checkout" class="checkout">
    <h2>Finalizar Compra</h2>

    <div id="orderSummary"></div>

    <h3>Dados Pessoais</h3>
    <input id="nome" placeholder="Nome completo">
    <input id="email" placeholder="Email">
    <input id="telefone" placeholder="Telefone">

    <h3>Endereço</h3>
    <label>CEP:</label>
    <input id="cepInput" placeholder="Digite seu CEP">
    <button id="cepSearch">Buscar CEP</button>
    <p id="cepResult"></p>

    <input id="rua" placeholder="Rua">
    <input id="numero" placeholder="Número">
    <input id="bairro" placeholder="Bairro">
    <input id="cidade" placeholder="Cidade">
    <input id="estado" placeholder="Estado">

    <h3>Frete</h3>
    <button id="freteBtn">Calcular Frete</button>
    <p id="freteResult"></p>

    <h3>Conversão de Moeda</h3>
    <button id="currencyBtn">Calcular Moeda</button>
    <p id="currencyResult"></p>

    <h3>Taxas</h3>
    <button id="taxBtn">Calcular Taxas</button>
    <p id="taxResult"></p>

    <h3>Pagamento</h3>
    <button id="payBtn">Pagar via PIX</button>
    <p id="payResult"></p>

</div>

<script>
    // ============================
    // RESUMO DO PEDIDO
    // ============================
    const livros = {
        domquixote: { title: "Dom Quixote", price: "99.90" },
        hp1: { title: "Harry Potter 1", price: "59.90" },
        dorian: { title: "Dorian Gray", price: "49.90" }
    };

    const p = new URLSearchParams(location.search);
    const livro = livros[p.get("book")];

    document.getElementById("orderSummary").innerHTML = `
        <p>Livro: <strong>${livro.title}</strong></p>
        <p>Preço: <strong>R$ ${livro.price}</strong></p>
    `;

    // ============================
    // API 1 — BUSCAR CEP
    // ============================
    document.getElementById("cepSearch").onclick = async () => {
        const cep = document.getElementById("cepInput").value;
        const cepResult = document.getElementById("cepResult");

        if (cep.length !== 8) {
            cepResult.textContent = "CEP inválido! Insira 8 dígitos.";
            return;
        }

        try {
            const r = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
            if (!r.ok) throw new Error("CEP não encontrado");

            const d = await r.json();

            cepResult.innerHTML = `Endereço encontrado: ${d.street} - ${d.city}/${d.state}`;

            document.getElementById("rua").value = d.street;
            document.getElementById("bairro").value = d.neighborhood;
            document.getElementById("cidade").value = d.city;
            document.getElementById("estado").value = d.state;

        } catch (error) {
            cepResult.textContent = `Erro ao buscar CEP: ${error.message}`;
        }
    };

    // ============================
    // API 3 — FRETE BASEADO NO CEP
    // ============================
    document.getElementById("freteBtn").onclick = async () => {
        const cep = document.getElementById("cepInput").value;
        const freteResult = document.getElementById("freteResult");

        if (cep.length !== 8) {
            freteResult.textContent = "Informe um CEP válido primeiro.";
            return;
        }

        try {
            const r = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
            const d = await r.json();

            let frete = 0;
            let prazo = "";

            if (d.state === "RS") { frete = 15; prazo = "3 a 5 dias"; }
            else if (["SC","PR"].includes(d.state)) { frete = 25; prazo = "4 a 7 dias"; }
            else { frete = 35; prazo = "6 a 10 dias"; }

            freteResult.innerHTML = `
                Frete para ${d.city}/${d.state}:<br>
                Valor: R$ ${frete.toFixed(2)}<br>
                Prazo: ${prazo}
            `;
        } catch {
            freteResult.textContent = "Erro ao calcular frete.";
        }
    };

    // ============================
    // API 4 — CONVERSÃO DE MOEDA
    // ============================
    document.getElementById("currencyBtn").onclick = async () => {
        const currencyResult = document.getElementById("currencyResult");
        try {
            const r = await fetch("https://economia.awesomeapi.com.br/json/last/USD-BRL,EUR-BRL");
            if (!r.ok) throw new Error("Erro ao buscar cotação");

            const data = await r.json();
            const dolar = parseFloat(data.USDBRL.ask);
            const euro = parseFloat(data.EURBRL.ask);
            const precoBRL = parseFloat(livro.price);

            currencyResult.innerHTML = `
                Preço em BRL: R$ ${precoBRL.toFixed(2)}<br>
                Aproximado em USD: $ ${(precoBRL/dolar).toFixed(2)}<br>
                Aproximado em EUR: € ${(precoBRL/euro).toFixed(2)}
            `;
        } catch {
            currencyResult.textContent = "Erro ao buscar cotação.";
        }
    };

    // ============================
    // API 2 — TAXAS
    // ============================
    document.getElementById("taxBtn").onclick = async () => {
        const taxResult = document.getElementById("taxResult");
        try {
            const r = await fetch("https://brasilapi.com.br/api/taxas/v1");
            const d = await r.json();
            const taxa = d[0];
            taxResult.innerHTML = `Taxa aplicada (${taxa.nome}): ${taxa.valor}%`;
        } catch {
            taxResult.textContent = "Erro ao carregar taxas.";
        }
    };

    // ============================
    // PAGAMENTO FAKE (PIX)
    // ============================
    document.getElementById("payBtn").onclick = async () => {
        const payResult = document.getElementById("payResult");
        const dados = {
            nome: document.getElementById("nome").value,
            email: document.getElementById("email").value,
            telefone: document.getElementById("telefone").value,
            endereco: {
                rua: document.getElementById("rua").value,
                numero: document.getElementById("numero").value,
                bairro: document.getElementById("bairro").value,
                cidade: document.getElementById("cidade").value,
                estado: document.getElementById("estado").value
            },
            entrega: document.getElementById("entrega") ? document.getElementById("entrega").value : "normal",
            livro: livro.title,
            preco: livro.price
        };

        try {
            const r = await fetch("https://jsonplaceholder.typicode.com/posts", {
                method: "POST",
                body: JSON.stringify(dados),
                headers: { "Content-Type": "application/json" }
            });

            const d = await r.json();
            payResult.innerHTML = `Pagamento confirmado!<br>ID PIX: <strong>${d.id}</strong>`;
        } catch {
            payResult.textContent = "Erro ao realizar pagamento.";
        }
    };
</script>

</body>
</html>
